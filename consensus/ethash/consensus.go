// Copyright 2017 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package ethash

import (
	"bytes"
	"errors"
	"fmt"
	"github.com/sero-cash/go-sero/zero/stake"
	"math/big"
	"runtime"
	"time"

	"github.com/sero-cash/go-sero/zero/zconfig"

	"github.com/sero-cash/go-czero-import/seroparam"
	"github.com/sero-cash/go-czero-import/superzk"

	"github.com/sero-cash/go-sero/crypto"

	"github.com/sero-cash/go-sero/zero/txs/assets"
	"github.com/sero-cash/go-sero/zero/utils"

	"github.com/sero-cash/go-sero/common"
	"github.com/sero-cash/go-sero/common/math"
	"github.com/sero-cash/go-sero/consensus"
	"github.com/sero-cash/go-sero/core/state"
	"github.com/sero-cash/go-sero/core/types"
	"github.com/sero-cash/go-sero/params"
)

// Ethash proof-of-work protocol constants.
var (
	allowedFutureBlockTime          = 15 * time.Second // Max time from current time allowed for blocks, before they're considered future blocks
	bigOne                 *big.Int = big.NewInt(1)
	big200W                *big.Int = big.NewInt(2000000)
)

// Various error messages to mark blocks invalid. These should be private to
// prevent engine specific errors from being referenced in the remainder of the
// codebase, inherently breaking if the engine is swapped out. Please put common
// error types into the consensus package.
var (
	errZeroBlockTime     = errors.New("timestamp equals parent's")
	errInvalidDifficulty = errors.New("non-positive difficulty")
	errInvalidMixDigest  = errors.New("invalid mix digest")
	errInvalidPoW        = errors.New("invalid proof-of-work")
)

// Author implements consensus.Engine, returning the header's coinbase as the
// proof-of-work verified author of the block.
func (ethash *Ethash) Author(header *types.Header) (common.Address, error) {
	return header.Coinbase, nil
}

// VerifyHeader checks whether a header conforms to the consensus rules of the
// stock Ethereum ethash engine.
func (ethash *Ethash) VerifyHeader(chain consensus.ChainReader, header *types.Header, seal bool) error {
	// If we're running a full engine faking, accept any input as valid
	if ethash.config.PowMode == ModeFullFake {
		return nil
	}
	// Short circuit if the header is known, or it's parent not
	number := header.Number.Uint64()
	if chain.GetHeader(header.Hash(), number) != nil {
		return nil
	}
	parent := chain.GetHeader(header.ParentHash, number-1)
	if parent == nil {
		return consensus.ErrUnknownAncestor
	}
	// Sanity checks passed, do a proper verification
	return ethash.verifyHeader(chain, header, parent, seal)
}

// VerifyHeaders is similar to VerifyHeader, but verifies a batch of headers
// concurrently. The method returns a quit channel to abort the operations and
// a results channel to retrieve the async verifications.
func (ethash *Ethash) VerifyHeaders(chain consensus.ChainReader, headers []*types.Header, seals []bool) (chan<- struct{}, <-chan error) {
	// If we're running a full engine faking, accept any input as valid
	if ethash.config.PowMode == ModeFullFake || len(headers) == 0 {
		abort, results := make(chan struct{}), make(chan error, len(headers))
		for i := 0; i < len(headers); i++ {
			results <- nil
		}
		return abort, results
	}

	// Spawn as many workers as allowed threads
	workers := runtime.GOMAXPROCS(0)
	if len(headers) < workers {
		workers = len(headers)
	}

	// Create a task channel and spawn the verifiers
	var (
		inputs = make(chan int)
		done   = make(chan int, workers)
		errors = make([]error, len(headers))
		abort  = make(chan struct{})
	)
	for i := 0; i < workers; i++ {
		go func() {
			for index := range inputs {
				errors[index] = ethash.verifyHeaderWorker(chain, headers, seals, index)
				done <- index
			}
		}()
	}

	errorsOut := make(chan error, len(headers))
	go func() {
		defer close(inputs)
		var (
			in, out = 0, 0
			checked = make([]bool, len(headers))
			inputs  = inputs
		)
		for {
			select {
			case inputs <- in:
				if in++; in == len(headers) {
					// Reached end of headers. Stop sending to workers.
					inputs = nil
				}
			case index := <-done:
				for checked[index] = true; checked[out]; out++ {
					errorsOut <- errors[out]
					if out == len(headers)-1 {
						return
					}
				}
			case <-abort:
				return
			}
		}
	}()
	return abort, errorsOut
}

func (ethash *Ethash) verifyHeaderWorker(chain consensus.ChainReader, headers []*types.Header, seals []bool, index int) error {
	var parent *types.Header
	if index == 0 {
		parent = chain.GetHeader(headers[0].ParentHash, headers[0].Number.Uint64()-1)
	} else if headers[index-1].Hash() == headers[index].ParentHash {
		parent = headers[index-1]
	}
	if parent == nil {
		return consensus.ErrUnknownAncestor
	}
	if chain.GetHeader(headers[index].Hash(), headers[index].Number.Uint64()) != nil {
		return nil // known block
	}
	return ethash.verifyHeader(chain, headers[index], parent, seals[index])
}

// verifyHeader checks whether a header conforms to the consensus rules of the
// stock Ethereum ethash engine.
// See YP section 4.3.4. "Block Header Validity"
func (ethash *Ethash) verifyHeader(chain consensus.ChainReader, header, parent *types.Header, seal bool) error {
	if !superzk.CheckLICr(header.Coinbase.ToPKr(), &header.Licr, header.Number.Uint64()) {
		return fmt.Errorf("invalid Licr : pkr %v, licr %v", header.Coinbase, header.Licr)
	}

	if !header.Valid() {
		return fmt.Errorf("invalid Licr : pkr %v, licr %v, disable", header.Coinbase, header.Licr)
	}
	// Ensure that the header's extra-data section is of a reasonable size
	if uint64(len(header.Extra)) > params.MaximumExtraDataSize {
		return fmt.Errorf("extra-data too long: %d > %d", len(header.Extra), params.MaximumExtraDataSize)
	}
	// Verify the header's timestamp
	if header.Time.Cmp(big.NewInt(time.Now().Add(allowedFutureBlockTime).Unix())) > 0 {
		return consensus.ErrFutureBlock
	}

	if header.Time.Cmp(parent.Time) <= 0 {
		return errZeroBlockTime
	}
	// Verify the block's difficulty based in it's timestamp and parent's difficulty
	expected := ethash.CalcDifficulty(chain, header.Time.Uint64(), parent)

	if expected.Cmp(header.Difficulty) != 0 {
		return fmt.Errorf("invalid difficulty: have %v, want %v", header.Difficulty, expected)
	}
	// Verify that the gas limit is <= 2^63-1
	cap := uint64(0x7fffffffffffffff)
	if header.GasLimit > cap {
		return fmt.Errorf("invalid gasLimit: have %v, max %v", header.GasLimit, cap)
	}
	// Verify that the gasUsed is <= gasLimit
	if header.GasUsed > header.GasLimit {
		return fmt.Errorf("invalid gasUsed: have %d, gasLimit %d", header.GasUsed, header.GasLimit)
	}

	// Verify that the gas limit remains within allowed bounds
	diff := int64(parent.GasLimit) - int64(header.GasLimit)
	divisor := uint64(1024)
	if diff < 0 {
		diff *= -1
		divisor = uint64(128)
	}
	limit := parent.GasLimit / divisor

	if uint64(diff) >= limit || header.GasLimit < params.MinGasLimit {
		return fmt.Errorf("invalid gas limit: have %d, want %d += %d", header.GasLimit, parent.GasLimit, limit)
	}
	// Verify that the block number is parent's +1
	if diff := new(big.Int).Sub(header.Number, parent.Number); diff.Cmp(big.NewInt(1)) != 0 {
		return consensus.ErrInvalidNumber
	}
	// Verify the engine specific seal securing the block
	if seal {
		if err := ethash.VerifySeal(chain, header); err != nil {
			return err
		}
	}
	return nil
}

// CalcDifficulty is the difficulty adjustment algorithm. It returns
// the difficulty that a new block should have when created at time
// given the parent block's time and difficulty.
func (ethash *Ethash) CalcDifficulty(chain consensus.ChainReader, time uint64, parent *types.Header) *big.Int {
	return CalcDifficulty(chain.Config(), time, parent)
}

// CalcDifficulty is the difficulty adjustment algorithm. It returns
// the difficulty that a new block should have when created at time
// given the parent block's time and difficulty.
func CalcDifficulty(config *params.ChainConfig, time uint64, parent *types.Header) *big.Int {
	if zconfig.IsTestFork() {
		if parent.Number.Uint64() >= zconfig.GetTestForkStartBlock() {
			return big.NewInt(10000)
		}
	}

	return calcDifficultyAutumnTwilight(time, parent)
}

// Some weird constants to avoid constant memory allocs for them.
var (
	expDiffPeriod = big.NewInt(100000)
	big1          = big.NewInt(1)
	big2          = big.NewInt(2)
	big6          = big.NewInt(6)
	big9          = big.NewInt(9)
	bigMinus99    = big.NewInt(-99)
)

// calcDifficultyAutumnTwilight is the difficulty adjustment algorithm. It returns
// the difficulty that a new block should have when created at time given the
// parent block's time and difficulty. The calculation uses the AutumnTwilight rules.
func calcDifficultyAutumnTwilight(time uint64, parent *types.Header) *big.Int {
	// https://github.com/ethereum/EIPs/issues/100.
	// algorithm:
	// diff = (parent_diff +
	//         (parent_diff / 2048 * max((1 - ((timestamp - parent.timestamp) // 9), -99))
	//        )
	bigTime := new(big.Int).SetUint64(time)
	bigParentTime := new(big.Int).Set(parent.Time)

	// holds intermediate values to make the algo easier to read & audit
	x := new(big.Int)
	y := new(big.Int)

	// 1 - (block_timestamp - parent_timestamp) // 9
	x.Sub(bigTime, bigParentTime)
	x.Div(x, big9)
	x.Sub(big1, x)
	// max(1 - (block_timestamp - parent_timestamp) // 9, -99)
	if x.Cmp(bigMinus99) < 0 {
		x.Set(bigMinus99)
	}
	// parent_diff + (parent_diff / 2048 * max(1 - ((timestamp - parent.timestamp) // 9), -99))
	y.Div(parent.Difficulty, params.DifficultyBoundDivisor)
	x.Mul(y, x)
	x.Add(parent.Difficulty, x)

	// minimum difficulty can ever be (before exponential factor)
	if x.Cmp(params.MinimumDifficulty) < 0 {
		x.Set(params.MinimumDifficulty)
	}
	return x
}

// calcDifficultyFrontier is the difficulty adjustment algorithm. It returns the
// difficulty that a new block should have when created at time given the parent
// block's time and difficulty. The calculation uses the Frontier rules.
func calcDifficultyFrontier(time uint64, parent *types.Header) *big.Int {
	diff := new(big.Int)
	adjust := new(big.Int).Div(parent.Difficulty, params.DifficultyBoundDivisor)
	bigTime := new(big.Int)
	bigParentTime := new(big.Int)

	bigTime.SetUint64(time)
	bigParentTime.Set(parent.Time)

	if bigTime.Sub(bigTime, bigParentTime).Cmp(params.DurationLimit) < 0 {
		diff.Add(parent.Difficulty, adjust)
	} else {
		diff.Sub(parent.Difficulty, adjust)
	}
	if diff.Cmp(params.MinimumDifficulty) < 0 {
		diff.Set(params.MinimumDifficulty)
	}

	periodCount := new(big.Int).Add(parent.Number, big1)
	periodCount.Div(periodCount, expDiffPeriod)
	if periodCount.Cmp(big1) > 0 {
		// diff = diff + 2^(periodCount - 2)
		expDiff := periodCount.Sub(periodCount, big2)
		expDiff.Exp(big2, expDiff, nil)
		diff.Add(diff, expDiff)
		diff = math.BigMax(diff, params.MinimumDifficulty)
	}
	return diff
}

// VerifySeal implements consensus.Engine, checking whether the given block satisfies
// the PoW difficulty requirements.
func (ethash *Ethash) VerifySeal(chain consensus.ChainReader, header *types.Header) error {
	// If we're running a fake PoW, accept any seal as valid
	if ethash.config.PowMode == ModeFake || ethash.config.PowMode == ModeFullFake {
		time.Sleep(ethash.fakeDelay)
		if ethash.fakeFail == header.Number.Uint64() {
			return errInvalidPoW
		}
		return nil
	}
	// If we're running a shared PoW, delegate verification to it
	if ethash.shared != nil {
		return ethash.shared.VerifySeal(chain, header)
	}
	// Ensure that we have a valid difficulty for the block
	if header.Difficulty.Sign() <= 0 {
		return errInvalidDifficulty
	}
	// Recompute the digest and PoW value and verify against the header
	number := header.Number.Uint64()

	cache := ethash.cache(number)
	size := datasetSize(number)
	if ethash.config.PowMode == ModeTest {
		size = 32 * 1024
	}

	var digest []byte
	var result []byte
	if number >= seroparam.SIP3() {
		// dataset := ethash.dataset_async(number)
		// if dataset.generated() {
		//	digest, result = progpowFull(dataset.dataset, header.HashPow().Bytes(), header.Nonce.Uint64(), number)
		// } else {
		digest, result = progpowLightWithoutCDag(size, cache.cache, cache.cdag, header.HashPow().Bytes(), header.Nonce.Uint64(), number)
		// }
	} else {
		digest, result = hashimotoLight(size, cache.cache, header.HashPow().Bytes(), header.Nonce.Uint64(), number)
	}
	// Caches are unmapped in a finalizer. Ensure that the cache stays live
	// until after the call to hashimotoLight so it's not unmapped while being used.
	runtime.KeepAlive(cache)

	if !bytes.Equal(header.MixDigest[:], digest) {
		return errInvalidMixDigest
	}
	target := new(big.Int).Div(maxUint256, header.ActualDifficulty())
	if new(big.Int).SetBytes(result).Cmp(target) > 0 {
		return errInvalidPoW
	}
	return nil
}

// Prepare implements consensus.Engine, initializing the difficulty field of a
// header to conform to the ethash protocol. The changes are done inline.
func (ethash *Ethash) Prepare(chain consensus.ChainReader, header *types.Header) error {
	parent := chain.GetHeader(header.ParentHash, header.Number.Uint64()-1)
	if parent == nil {
		return consensus.ErrUnknownAncestor
	}
	header.Difficulty = ethash.CalcDifficulty(chain, header.Time.Uint64(), parent)
	return nil
}

var code = common.Hex2Bytes("6080604052600436106100da5763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416631865ac3281146100df5780631a9a04261461014e578063200388161461017057806322e011921461017b57806328a0ac34146101d65780634be41aea14610260578063524f3889146102b957806373183b981461032457806378f120b1146103725780637c510eb4146103cb57806383e4cccf146103e05780638da5cb5b146103f85780639201de5514610429578063f2fde38b14610441578063fa30b25114610464575b600080fd5b3480156100eb57600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526101389436949293602493928401919081908401838280828437509497506104b09650505050505050565b6040805160ff9092168252519081900360200190f35b61015c60ff600435166104d6565b604080519115158252519081900360200190f35b61015c6004356105b6565b34801561018757600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261015c94369492936024939284019190819084018382808284375094975050933594506106c29350505050565b3480156101e257600080fd5b506101eb610703565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561022557818101518382015260200161020d565b50505050905090810190601f1680156102525780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561026c57600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261015c9436949293602493928401919081908401838280828437509497506107249650505050505050565b3480156102c557600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261031294369492936024939284019190819084018382808284375094975061073c9650505050505050565b60408051918252519081900360200190f35b6040805160206004803580820135601f810184900484028501840190955284845261015c94369492936024939284019190819084018382808284375094975050933594506107549350505050565b34801561037e57600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526103129436949293602493928401919081908401838280828437509497506108369650505050505050565b3480156103d757600080fd5b506101eb61084e565b3480156103ec57600080fd5b5061015c60043561086f565b34801561040457600080fd5b5061040d6108fa565b60408051600160a060020a039092168252519081900360200190f35b34801561043557600080fd5b506101eb600435610909565b34801561044d57600080fd5b50610462600160a060020a0360043516610ac2565b005b6040805160206004803580820135601f8101849004840285018401909552848452610312943694929360249392840191908190840183828082843750949750610b579650505050505050565b60006104cc6104be83610c59565b600c9063ffffffff610c6016565b6080015192915050565b6000806104e161122e565b6104e9610d08565b915061051b60408051908101604052806004815260200160e160020a6321a7a4a702815250610516610d3b565b610d7c565b151561052657600080fd5b81151561053257600080fd5b610543600c8363ffffffff610daa16565b8051909150151561055357600080fd5b805161056890600c908663ffffffff610de716565b151561057357600080fd5b81600019166105a2338460408051908101604052806004815260200160e160020a6321a7a4a702815250610e60565b146105ac57600080fd5b5060019392505050565b6000806105c161122e565b60606105cb610d08565b92506105f860408051908101604052806004815260200160e160020a6321a7a4a702815250610516610d3b565b151561060357600080fd5b82151561060f57600080fd5b610620600c8463ffffffff610daa16565b8051909250151561063057600080fd5b815161063b90610909565b90506106478582610eaa565b151561065257600080fd5b61065d338287610eea565b151561066857600080fd5b8260001916610697338560408051908101604052806004815260200160e160020a6321a7a4a702815250610e60565b146106a157600080fd5b81516106b690600c908763ffffffff610f1516565b50600195945050505050565b600b54600090600160a060020a031633146106dc57600080fd5b6106f76106e884610c59565b600c908463ffffffff610f9a16565b50600190505b92915050565b604080518082019091526004815260e060020a635345524f02602082015281565b60006107326104be83610c59565b6060015192915050565b600061074a6104be83610c59565b6020015192915050565b600b5460009081908190600160a060020a0316331461077257600080fd5b61077b85610c59565b915061078e600c8363ffffffff610ff216565b1561079857600080fd5b6107a3600086610eaa565b15156107ae57600080fd5b6107dc60008060010260408051908101604052806004815260200160e160020a6321a7a4a702815250610e60565b90508015156107ea57600080fd5b6040805160c081018252838152602081018690529081018290526000606082018190526080820181905260a082015261082b90600c9063ffffffff61100916565b506001949350505050565b60006108446104be83610c59565b60a0015192915050565b604080518082019091526004815260e160020a6321a7a4a702602082015281565b600b54600090600160a060020a0316331461088957600080fd5b816108b260408051908101604052806004815260200160e060020a635345524f0281525061109f565b10156108bd57600080fd5b6108e73360408051908101604052806004815260200160e060020a635345524f0281525084610eea565b15156108f257600080fd5b506001919050565b600b54600160a060020a031681565b60408051602080825281830190925260609160009183918391829184919080820161040080388339019050509350600092505b60208310156109d8576008830260020a870291507fff000000000000000000000000000000000000000000000000000000000000008216156109c25781848681518110151561098757fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053506001909401936109cd565b84156109cd576109d8565b60019092019161093c565b846040519080825280601f01601f191660200182016040528015610a06578160200160208202803883390190505b509050600092505b84831015610ab8578383815181101515610a2457fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000028184815181101515610a7d57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600190920191610a0e565b9695505050505050565b600b54600160a060020a03163314610ad957600080fd5b600160a060020a0381161515610aee57600080fd5b600b54604051600160a060020a038084169216907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a3600b805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b600080610b6261122e565b610b6b84610c59565b9150610b7e600c8363ffffffff610ff216565b1515610b8957600080fd5b610b9a600c8363ffffffff6110d616565b1515610ba557600080fd5b610bd060408051908101604052806004815260200160e060020a635345524f02815250610516611178565b1515610bdb57600080fd5b610bec600c8363ffffffff610c6016565b905060008160200151118015610c06575034816020015111155b1515610c1157600080fd5b610c3f33826040015160408051908101604052806004815260200160e160020a6321a7a4a702815250610e60565b604082015114610c4e57600080fd5b604001519392505050565b6020015190565b610c6861122e565b60008281526001840160205260409020548015801590610c89575083548111155b15610d0157835484906000198301908110610ca057fe5b60009182526020918290206040805160c081018252600590930290910180548352600181015493830193909352600283015490820152600382015460ff8082161515606084015261010090910416608082015260049091015460a082015291505b5092915050565b6040805160208082528183019092526000916060919080820161040080388339019050509050600654602082a151919050565b604080516020808252818301909252606091829160009180820161040080388339019050509150600554602083a1508051610d7581610909565b9250505090565b8051825160009114610d90575060006106fd565b610d9982610c59565b610da284610c59565b1490506106fd565b610db261122e565b60008281526002840160205260409020548015801590610c89575083548111610d0157835484906000198301908110610ca057fe5b60008281526001840160205260408120548015801590610e08575084548111155b15610e53578454839086906000198401908110610e2157fe5b906000526020600020906005020160030160016101000a81548160ff021916908360ff16021790555060019150610e58565b600091505b509392505050565b60408051606080825260808201909252600091908160208201610c008038833901905050905080848152856020820152836040820152600454606082a16040015195945050505050565b60408051818152606080820183526000929091906020820161080080388339019050509050828152836020820152600054604082a1602001519392505050565b6000610f0d848484602060405190810160405280600081525060006001026111b2565b949350505050565b60008281526001840160205260408120548015801590610f36575084548111155b15610e5357610f6a838660000160018403815481101515610f5357fe5b90600052602060002090600502016004015461120a565b855486906000198401908110610f7c57fe5b90600052602060002090600502016004018190555060019150610e58565b60008281526001840160205260408120548015801590610fbb575084548111155b15610e53578454839086906000198401908110610fd457fe5b90600052602060002090600502016001018190555060019150610e58565b600090815260019190910160205260408120541190565b815460018181018455600084815260208082208551600590950201848155818601518185015560408087018051600280850191909155606089015160038501805460808c015160ff166101000261ff001993151560ff19909216919091179290921691909117905560a0909801516004909301929092558754958452938701825283832085905551825293909401909252912055565b6040805160208082528183019092526000916060919080820161040080388339019050509050828152600154602082a15192915050565b600081815260018301602052604081205480158015906110f7575083548111155b8015611129575083548490600019830190811061111057fe5b600091825260209091206003600590920201015460ff16155b1561116e5783546001908590600019840190811061114357fe5b60009182526020909120600590910201600301805460ff191691151591909117905560019150610d01565b5060009392505050565b604080516020808252818301909252606091829160009180820161040080388339019050509150600354602083a1508051610d7581610909565b6040805160a080825260c0820190925260009160609190602082016114008038833901905050905086815285602082015284604082015283606082015282608082015260025460a082a1608001519695505050505050565b600082820183811080159061121f5750828110155b151561122757fe5b9392505050565b6040805160c081018252600080825260208201819052918101829052606081018290526080810182905260a0810191909152905600a165627a7a723058200dfb18d79af69ebdfa53281c34a31c125bcaff79625949e1fd91406ce1dd7b5e0029")

var code0 = common.Hex2Bytes("6080604052600436106100ae5763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416630a8b782681146100b35780632ca9a7c114610101578063370158ea146101165780633ccfd60b146101bf578063672d7a0d146101d457806383b4918b146101f55780638da5cb5b1461020d578063a19556d41461023e578063a551878e1461030c578063e7cf3d1314610321578063f2fde38b14610376575b600080fd5b6040805160206004803580820135601f81018490048402850184019095528484526100ff9436949293602493928401919081908401838280828437509497506103979650505050505050565b005b34801561010d57600080fd5b506100ff61048d565b34801561012257600080fd5b5061012b6105ca565b6040518086815260200185815260200184815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610180578181015183820152602001610168565b50505050905090810190601f1680156101ad5780820380516001836020036101000a031916815260200191505b50965050505050505060405180910390f35b3480156101cb57600080fd5b506100ff61084d565b3480156101e057600080fd5b506100ff600160a060020a0360043516610a42565b34801561020157600080fd5b506100ff600435610bf7565b34801561021957600080fd5b50610222610ce1565b60408051600160a060020a039092168252519081900360200190f35b34801561024a57600080fd5b506040805160206004803580820135601f8101849004840285018401909552848452610297943694929360249392840191908190840183828082843750949750610cf09650505050505050565b6040805160208082528351818301528351919283929083019185019080838360005b838110156102d15781810151838201526020016102b9565b50505050905090810190601f1680156102fe5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561031857600080fd5b506100ff6117c1565b34801561032d57600080fd5b50604080516020600480358082013583810280860185019096528085526100ff9536959394602494938501929182918501908490808284375094975061182f9650505050505050565b34801561038257600080fd5b506100ff600160a060020a0360043516611896565b600080600754600014806103ac575060075442105b15156103b757600080fd5b6103e760408051908101604052806004815260200160e060020a635345524f028152506103e261192a565b61196b565b15156103f257600080fd5b678ac7230489e8000034101561040757600080fd5b3360009081526009602052604090205491508115156104605761043a83602060405190810160405280600081525061196b565b1561044457600080fd5b61044d836119b7565b3360009081526009602052604090205491505b600880548390811061046e57fe5b90600052602060002090600d0201905061048881346120ab565b505050565b600080600080600080600060075460001415156104a957600080fd5b3360009081526009602052604090205496508615156104c757600080fd5b6104cf612302565b600d5415806104de5750600e54155b156104e8576105c1565b8693505b6008546011546104fe91908901612330565b8410801561050c5750600754155b1561059457600880548590811061051f57fe5b90600052602060002090600d0201925061053d836006015442612347565b158015610551575082600301548360020154115b156105895761055f8361235c565b9092509050610574868363ffffffff6124ef16565b9550610586858263ffffffff6124ef16565b94505b6001909301926104ec565b6013546105a7908663ffffffff6124ef16565b601355600f546105bd908763ffffffff61250c16565b600f555b50505050505050565b6000806000806060806060806000600754600014151561081f576105ee600a612523565b9250825160405190808252806020026020018201604052801561062b57816020015b61061861377d565b8152602001906001900390816106105790505b509150600090505b825181101561078057600554835161076091600160a060020a031690633a5294a09086908590811061066157fe5b906020019060200201516040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808267ffffffffffffffff1667ffffffffffffffff168152602001915050600060405180830381600087803b1580156106d157600080fd5b505af11580156106e5573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052602081101561070e57600080fd5b81019080805164010000000081111561072657600080fd5b8201602081018481111561073957600080fd5b815164010000000081118282018710171561075357600080fd5b505092919050505061257f565b828281518110151561076e57fe5b60209081029091010152600101610633565b6107c76107c16040805190810160405280600181526020017f200000000000000000000000000000000000000000000000000000000000000081525061257f565b836125a5565b93506007546108066013546107fa60408051908101604052806004815260200160e060020a635345524f028152506126ed565b9063ffffffff61250c16565b6012546008805490508798509850985098509850610842565b601254600854604080516020810190915260008082529b508b9a50919850965094505b505050509091929394565b3360009081526009602052604081205490808080808086151561086f57600080fd5b600880548890811061087d57fe5b90600052602060002090600d02019550856009015494506007546000141580156108a8575060075442115b15610950576108db6013546107fa60408051908101604052806004815260200160e060020a635345524f028152506126ed565b93506108ee600a8863ffffffff61272416565b925092508280156108ff5750600082115b156109505761093d610930610914600a612787565b610924878663ffffffff6127bd16565b9063ffffffff6127eb16565b869063ffffffff6124ef16565b9450610950600a8863ffffffff61280e16565b60098601546013546109679163ffffffff61250c16565b60135560006009870155600c86015415156109b6576109a63360408051908101604052806004815260200160e060020a635345524f0281525087612863565b15156109b157600080fd5b6105c1565b5060005b600c8601548110156105c157610a2f86600c01828154811015156109da57fe5b60009182526020918290200154604080518082019091526004815260e060020a635345524f0292810192909252600c890154600160a060020a039091169190610a2a90899063ffffffff6127eb16565b612863565b1515610a3a57600080fd5b6001016109ba565b60008054600160a060020a03163314610a5a57600080fd5b610a638261288e565b15610a6d57600080fd5b5060088054600160a060020a038316600090815260096020908152604080832084905580516101a081018252848152808301849052808201849052606081018490526080810184905260a081018490524260c0820181905260e0820185905261010082015261012081018490528151848152928301909152929392916101408301919050815260408051602081810183526000808352818501929092528251828152908101835291909201915090528154600181810180855560009485526020948590208451600d90940201928355848401519183019190915560408301516002830155606083015160038301556080830151600483015560a0830151600583015560c0830151600683015560e083015160078301556101008301516008830155610120830151600983015561014083015180519194610bb592600a85019290910190613794565b506101608201518051610bd291600b8401916020909101906137df565b506101808201518051610bef91600c84019160209091019061384c565b505050505050565b60008082678ac7230489e80000111580610c0f575082155b1515610c1a57600080fd5b6007541580610c2a575060075442105b1515610c3557600080fd5b336000908152600960205260409020549150811515610c5357600080fd5b6008805483908110610c6157fe5b90600052602060002090600d020190508260001415610c965760098101549250678ac7230489e80000831015610c9657600080fd5b6009810154831115610ca757600080fd5b6009810154610cbc908463ffffffff61250c16565b6009820155601354610cd4908463ffffffff61250c16565b60135561048881846120ab565b600054600160a060020a031681565b33600090815260096020526040812054606091908190839082908190819081901515610d1b576117b5565b33600090815260096020526040902054600880549091908110610d3a57fe5b90600052602060002090600d02019650610d6489602060405190810160405280600081525061196b565b1515610ee1576005546040517f49145c910000000000000000000000000000000000000000000000000000000081526020600482018181528c5160248401528c51600160a060020a03909416936349145c91938e9383926044909201919085019080838360005b83811015610de3578181015183820152602001610dcb565b50505050905090810190601f168015610e105780820380516001836020036101000a031916815260200191505b5092505050602060405180830381600087803b158015610e2f57600080fd5b505af1158015610e43573d6000803e3d6000fd5b505050506040513d6020811015610e5957600080fd5b50519550600086118015610e6e575060085486105b1515610e7957600080fd5b6008805487908110610e8757fe5b90600052602060002090600d020196505b336000908152600960205260409020548614610ee157851515610eba576117b5565b6008805487908110610ec857fe5b90600052602060002090600d0201600101549550610e98565b610ee9612302565b60408051600b808252610180820190925290816020015b6060815260200190600190039081610f00575050604080518082018252600a81527f2273656c66436f6465220000000000000000000000000000000000000000000060208201526005548a54835160e560020a6301d294a502815267ffffffffffffffff90911660048201529251939850611039939192600160a060020a0390911691633a5294a09160248082019260009290919082900301818387803b158015610faa57600080fd5b505af1158015610fbe573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526020811015610fe757600080fd5b810190808051640100000000811115610fff57600080fd5b8201602081018481111561101257600080fd5b815164010000000081118282018710171561102c57600080fd5b5050929190505050612896565b85600081518110151561104857fe5b906020019060200201819052506111c16040805190810160405280600c81526020017f22706172656e74436f646522000000000000000000000000000000000000000081525088600101546000146111875760055460018a01546040805160e560020a6301d294a502815267ffffffffffffffff909216600483015251600160a060020a0390921691633a5294a09160248082019260009290919082900301818387803b1580156110f857600080fd5b505af115801561110c573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052602081101561113557600080fd5b81019080805164010000000081111561114d57600080fd5b8201602081018481111561116057600080fd5b815164010000000081118282018710171561117a57600080fd5b50509291905050506111bc565b60408051808201909152600281527f222200000000000000000000000000000000000000000000000000000000000060208201525b612896565b8560018151811015156111d057fe5b906020019060200201819052506112206040805190810160405280600781526020017f2276616c756522000000000000000000000000000000000000000000000000008152508860020154612a7d565b85600281518110151561122f57fe5b9060200190602002018190525061127f6040805190810160405280600d81526020017f2272657475726e56616c756522000000000000000000000000000000000000008152508860030154612a7d565b85600381518110151561128e57fe5b906020019060200201819052506112de6040805190810160405280601481526020017f22746f74616c41796e616d6963526577617264220000000000000000000000008152508860040154612a7d565b8560048151811015156112ed57fe5b60209081029091010152600987015460075490945015801590611311575060075442115b156113af576113446013546107fa60408051908101604052806004815260200160e060020a635345524f028152506126ed565b3360009081526009602052604090205490935061136990600a9063ffffffff61272416565b9150915081801561137a5750600081115b156113af576113ac61139f61138f600a612787565b610924868563ffffffff6127bd16565b859063ffffffff6124ef16565b93505b6113ee6040805190810160405280600d81526020017f2263616e5769746864726177220000000000000000000000000000000000000081525085612a7d565b8560058151811015156113fd57fe5b6020908102909101015260068701546114169042612347565b1561147c5761145e6040805190810160405280600e81526020017f22737461746963526577617264220000000000000000000000000000000000008152508860050154612a7d565b85600681518110151561146d57fe5b602090810290910101526114f8565b6114de6040805190810160405280600e81526020017f22737461746963526577617264220000000000000000000000000000000000008152506114d9896114d48b600301548c6002015461250c90919063ffffffff16565b612b44565b612a7d565b8560068151811015156114ed57fe5b602090810290910101525b611506876008015442612347565b1561156c5761154e6040805190810160405280600f81526020017f2264796e616d69635265776172642200000000000000000000000000000000008152508860070154612a7d565b85600781518110151561155d57fe5b602090810290910101526115c6565b6115ac6040805190810160405280600f81526020017f2264796e616d69635265776172642200000000000000000000000000000000008152506000612a7d565b8560078151811015156115bb57fe5b602090810290910101525b6116096040805190810160405280601181526020017f2273746174696354696d657374616d70220000000000000000000000000000008152508860060154612a7d565b85600881518110151561161857fe5b6020908102909101810191909152604080518082018252600c81527f226368696c6473436f646522000000000000000000000000000000000000000081840152600b8a0180548351601f600260001961010060018616150201909316929092049182018690048602810186019094528084526116ec949293928301828280156116e25780601f106116b7576101008083540402835291602001916116e2565b820191906000526020600020905b8154815290600101906020018083116116c557829003601f168201915b5050505050612896565b8560098151811015156116fb57fe5b6020908102909101810191909152604080518082018252600881527f2276616c7565732200000000000000000000000000000000000000000000000081840152600a8a0180548351818602810186019094528084526117909492939283018282801561178657602002820191906000526020600020905b815481526020019060010190808311611772575b5050505050612bf0565b85600a81518110151561179f57fe5b602090810290910101526117b285612e29565b97505b50505050505050919050565b600054600160a060020a031633146117d857600080fd5b600054604080518082018252600480825260e060020a635345524f02602080840182905284518086019095529184529083015261182292600160a060020a031691610a2a906126ed565b151561182d57600080fd5b565b6000806000835111151561184257600080fd5b336000908152600960205260409020549150811561048857600880548390811061186857fe5b90600052602060002090600d020190508281600c01908051906020019061189092919061384c565b50505050565b600054600160a060020a031633146118ad57600080fd5b600160a060020a03811615156118c257600080fd5b60008054604051600160a060020a03808516939216917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e091a36000805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b604080516020808252818301909252606091829160009180820161040080388339019050509150600454602083a150805161196481612f91565b9250505090565b60008251600014801561197d57508151155b1561198a575060016119b1565b815183511461199b575060006119b1565b6119a482613112565b6119ad84613112565b1490505b92915050565b60008060006119c53361288e565b156119cf57600080fd5b6005546040517f49145c91000000000000000000000000000000000000000000000000000000008152602060048201818152875160248401528751600160a060020a03909416936349145c9193899383926044909201919085019080838360005b83811015611a48578181015183820152602001611a30565b50505050905090810190601f168015611a755780820380516001836020036101000a031916815260200191505b5092505050602060405180830381600087803b158015611a9457600080fd5b505af1158015611aa8573d6000803e3d6000fd5b505050506040513d6020811015611abe57600080fd5b50519250600083118015611ad3575060085483105b1515611ade57600080fd5b6008805484908110611aec57fe5b60009182526020808320600854604080518085018252958652600d94909402909101600b81018054855160026001831615610100026000190190921691909104601f8101869004860282018601909652858152919750919550611ba794939092830182828015611b9d5780601f10611b7257610100808354040283529160200191611b9d565b820191906000526020600020905b815481529060010190602001808311611b8057829003601f168201915b505050505061196b565b15611ca8576005546040805160e560020a6301d294a502815267ffffffffffffffff841660048201529051600160a060020a0390921691633a5294a09160248082019260009290919082900301818387803b158015611c0557600080fd5b505af1158015611c19573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526020811015611c4257600080fd5b810190808051640100000000811115611c5a57600080fd5b82016020810184811115611c6d57600080fd5b8151640100000000811182820187101715611c8757600080fd5b50508051611ca29450600b87019350602090910191506137df565b50611e04565b600b8201805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152611dec93611d9293611d8d93611d4a939291830182828015611d405780601f10611d1557610100808354040283529160200191611d40565b820191906000526020600020905b815481529060010190602001808311611d2357829003601f168201915b505050505061257f565b611d886040805190810160405280600181526020017f200000000000000000000000000000000000000000000000000000000000000081525061257f565b613119565b61257f565b6005546040805160e560020a6301d294a502815267ffffffffffffffff861660048201529051611d8892600160a060020a031691633a5294a091602480830192600092919082900301818387803b1580156106d157600080fd5b8051611e0291600b8501916020909101906137df565b505b33600090815260096020908152604080832084905580516101a081018252848152808301878152818301858152606083018681526080840187815260a085018881524260c0870181815260e088018b8152610100890192835261012089018c81528a518d8152808d018c526101408b019081528b51808e018d528e81526101608c01528b518e8152808e01909c526101808b019b909b52600880546001810180835591909e528a517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee3600d909f029e8f0190815599517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee48f015597517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee58e015595517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee68d015593517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee78c015591517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee88b015590517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee98a015590517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636eea890155517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636eeb880155517ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636eec87015592518051939592949193612067937ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636eed01929190910190613794565b50610160820151805161208491600b8401916020909101906137df565b5061018082015180516120a191600c84019160209091019061384c565b5050505050505050565b6000806000806120b9612302565b6120dc6120cd86603263ffffffff6127eb16565b6012549063ffffffff6124ef16565b601255600054604080518082019091526004815260e060020a635345524f02602082015261211f91600160a060020a031690610a2a88603263ffffffff6127eb16565b151561212a57600080fd5b6006546121429061092487601963ffffffff6127eb16565b9350600092505b6006548310156121b8576121a260068481548110151561216557fe5b60009182526020918290200154604080518082019091526004815260e060020a635345524f0292810192909252600160a060020a03169086612863565b15156121ad57600080fd5b600190920191612149565b6121dd6121cc86600363ffffffff6127bd16565b60028801549063ffffffff6124ef16565b60028701556001860154600010156122b2575084905060005b6001820154158015906122095750601481105b156122b2576008826001015481548110151561222157fe5b90600052602060002090600d020191508082600a0180549050141561225f57600a8201805460018101825560009182526020909120018590556122aa565b61228d8583600a018381548110151561227457fe5b90600052602060002001546124ef90919063ffffffff16565b600a830180548390811061229d57fe5b6000918252602090912001555b6001016121f6565b6122d56122c686600363ffffffff6127bd16565b600f549063ffffffff6124ef16565b600f5585546122ed90600a908763ffffffff61319016565b60075415610bef576000600755505050505050565b61230e42601054612347565b151561182d57612321606461092461334f565b600e55600f54600d5542601055565b6000818310156123415750816119b1565b50919050565b610e1060189283900481900492909104041490565b60008060008060008060008061238c896123878b600301548c6002015461250c90919063ffffffff16565b61338f565b95509550851561239b576124e4565b8493506000896001015411156124dd57600889600101548154811015156123be57fe5b90600052602060002090600d020191506123da828660006134ac565b909650925085156123f0578484975097506124e4565b612400848463ffffffff6124ef16565b9350600190505b60018201541580159061241a5750601481105b80156124265750600754155b156124dd576008826001015481548110151561243e57fe5b90600052602060002090600d020191508061248869021e19e0c9bab240000084600a01600081548110151561246f57fe5b90600052602060002001546127eb90919063ffffffff16565b11801561249c575081600201548260030154105b156124d5576124ac8286836134ac565b909650925085156124c2578484975097506124e4565b6124d2848463ffffffff6124ef16565b93505b600101612407565b8484975097505b505050505050915091565b60008282018381101561250157600080fd5b8091505b5092915050565b6000808383111561251c57600080fd5b5050900390565b60608160000180548060200260200160405190810160405280929190818152602001828054801561257357602002820191906000526020600020905b81548152602001906001019080831161255f575b50505050509050919050565b61258761377d565b50604080518082019091528151815260209182019181019190915290565b6060600080606060008551600014156125ce5760408051602081019091526000815294506126e3565b60018651038760000151029350600092505b85518310156126125785838151811015156125f757fe5b602090810290910101515193909301926001909201916125e0565b836040519080825280601f01601f191660200182016040528015612640578160200160208202803883390190505b5060009350915050602081015b85518310156126df5761269481878581518110151561266857fe5b9060200190602002015160200151888681518110151561268457fe5b60209081029091010151516135a9565b85838151811015156126a257fe5b60209081029091010151518651910190600019018310156126d4576126d081886020015189600001516135a9565b8651015b60019092019161264d565b8194505b5050505092915050565b6040805160208082528183019092526000916060919080820161040080388339019050509050828152600254602082a15192915050565b600080805b845481101561277f578454849086908390811061274257fe5b9060005260206000200154141561277757600285018054600194508290811061276757fe5b9060005260206000200154820191505b600101612729565b509250929050565b6000805b825481101561234157600283018054829081106127a457fe5b600091825260209091200154919091019060010161278b565b6000808315156127d05760009150612505565b508282028284828115156127e057fe5b041461250157600080fd5b6000808083116127fa57600080fd5b828481151561280557fe5b04949350505050565b60005b8254811015610488578254829084908390811061282a57fe5b9060005260206000200154141561285b576000836002018281548110151561284e57fe5b6000918252602090912001555b600101612811565b6000612886848484602060405190810160405280600081525060006001026135ed565b949350505050565b6000903b1190565b604080516002808252606082810190935282918291816020015b6128b861377d565b8152602001906001900390816128b05790505091506128d68561257f565b8260008151811015156128e557fe5b602090810290910101526040805160038082526080820190925290816020015b61290d61377d565b8152602001906001900390816129055790505090506129606040805190810160405280600181526020017f220000000000000000000000000000000000000000000000000000000000000081525061257f565b81600081518110151561296f57fe5b602090810290910101526129828461257f565b81600181518110151561299157fe5b906020019060200201819052506129dc6040805190810160405280600181526020017f220000000000000000000000000000000000000000000000000000000000000081525061257f565b8160028151811015156129eb57fe5b90602001906020020181905250612a17611d8d6107c1602060405190810160405280600081525061257f565b826001815181101515612a2657fe5b90602001906020020181905250612a746107c16040805190810160405280600181526020017f3a0000000000000000000000000000000000000000000000000000000000000081525061257f565b95945050505050565b6040805160028082526060828101909352829190816020015b612a9e61377d565b815260200190600190039081612a96579050509050612abc8461257f565b816000815181101515612acb57fe5b60209081029091010152612ae1611d8d84613645565b816001815181101515612af057fe5b90602001906020020181905250612886612b3e6040805190810160405280600181526020017f3a0000000000000000000000000000000000000000000000000000000000000081525061257f565b826125a5565b6000600e5460001480612b575750600d54155b80612b63575060075415155b15612b70575060006119b1565b612bac82612ba7600d54610924600e54612b9b89600301548a6002015461250c90919063ffffffff16565b9063ffffffff6127bd16565b612330565b90508260020154612bca8460030154836124ef90919063ffffffff16565b11156119b15760038301546002840154612be99163ffffffff61250c16565b9392505050565b60608060006060808551604051908082528060200260200182016040528015612c3357816020015b612c2061377d565b815260200190600190039081612c185790505b509350600092505b8551831015612c8a57612c67611d8d8785815181101515612c5857fe5b90602001906020020151613645565b8484815181101515612c7557fe5b60209081029091010152600190920191612c3b565b612d15612ccb6040805190810160405280600181526020017f5b0000000000000000000000000000000000000000000000000000000000000081525061257f565b611d88611d8d612d0f6040805190810160405280600181526020017f2c0000000000000000000000000000000000000000000000000000000000000081525061257f565b886125a5565b9150612d61612d238361257f565b611d886040805190810160405280600181526020017f5d0000000000000000000000000000000000000000000000000000000000000081525061257f565b60408051600280825260608201909252919350816020015b612d8161377d565b815260200190600190039081612d79579050509050612d9f8761257f565b816000815181101515612dae57fe5b60209081029091010152612dc18261257f565b816001815181101515612dd057fe5b90602001906020020181905250612e1e612b3e6040805190810160405280600181526020017f3a0000000000000000000000000000000000000000000000000000000000000081525061257f565b979650505050505050565b60608060008351604051908082528060200260200182016040528015612e6957816020015b612e5661377d565b815260200190600190039081612e4e5790505b509150600090505b8351811015612eba57612e9a8482815181101515612e8b57fe5b9060200190602002015161257f565b8282815181101515612ea857fe5b60209081029091010152600101612e71565b612f45612efb6040805190810160405280600181526020017f7b0000000000000000000000000000000000000000000000000000000000000081525061257f565b611d88611d8d612f3f6040805190810160405280600181526020017f2c0000000000000000000000000000000000000000000000000000000000000081525061257f565b866125a5565b9250612886612f538461257f565b611d886040805190810160405280600181526020017f7d0000000000000000000000000000000000000000000000000000000000000081525061257f565b60408051602080825281830190925260609160009183918391829184919080820161040080388339019050509350600092505b6020831015613060576008830260020a870291507fff0000000000000000000000000000000000000000000000000000000000000082161561304a5781848681518110151561300f57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600190940193613055565b841561305557613060565b600190920191612fc4565b846040519080825280601f01601f19166020018201604052801561308e578160200160208202803883390190505b509050600092505b848310156131085783838151811015156130ac57fe5b90602001015160f860020a900460f860020a0281848151811015156130cd57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600190920191613096565b9695505050505050565b6020015190565b606080600083600001518560000151016040519080825280601f01601f191660200182016040528015613156578160200160208202803883390190505b50915060208201905061317281866020015187600001516135a9565b84516020850151855161318892840191906135a9565b509392505050565b8254600090819081908190600a141561327f5760018701805460009081106131b457fe5b90600052602060002001549250600191505b865482101561321e578287600101838154811015156131e157fe5b90600052602060002001541015613213576001870180548390811061320257fe5b906000526020600020015492508193505b6001909101906131c6565b8654869088908690811061322e57fe5b906000526020600020018190555042876001018581548110151561324e57fe5b906000526020600020018190555084876002018581548110151561326e57fe5b6000918252602090912001556105c1565b600091505b86548210156132ff578654869088908490811061329d57fe5b906000526020600020015414156132f4574287600101838154811015156132c057fe5b90600052602060002001819055508487600201838154811015156132e057fe5b6000918252602090912001555060016132ff565b600190910190613284565b8015156105c1575050845460018082018755600087815260208082209093019690965580870180548083018255908752828720429101556002909601805496870181558552909320909301555050565b60006133896012546107fa6013546107fa346107fa60408051908101604052806004815260200160e060020a635345524f028152506126ed565b90505b90565b60008060008061339d613750565b600754156133b25760019350600092506134a3565b4260068701556133c28686612b44565b925082866005018190555060008660010154111561346e575084905060005b6001820154158015906133f45750601481105b1561346e576008826001015481548110151561340c57fe5b90600052602060002090600d0201915061344a8383600a018381548110151561343157fe5b906000526020600020015461250c90919063ffffffff16565b600a830180548390811061345a57fe5b6000918252602090912001556001016133e1565b6009860154613483908463ffffffff6124ef16565b6009870155600386015461349d908463ffffffff6124ef16565b60038701555b50509250929050565b6000806134b7613750565b600754156134cb57506001905060006135a1565b69152d02c7e14af68000006134f660036109248860030154896002015461250c90919063ffffffff16565b1061350257508261350f565b61350c8585612b44565b90505b600083111561352c5761352981600a63ffffffff6127eb16565b90505b61353a856008015442612347565b1561355e576007850154613554908263ffffffff6124ef16565b600786015561356c565b600785018190554260088601555b6009850154613581908263ffffffff6124ef16565b6009860155600485015461359b908263ffffffff6124ef16565b60048601555b935093915050565b60005b602082106135ce578251845260209384019390920191601f19909101906135ac565b50905182516020929092036101000a6000190180199091169116179052565b6040805160a080825260c0820190925260009160609190602082016114008038833901905050905086815285602082015284604082015283606082015282608082015260035460a082a1608001519695505050505050565b6060600080828185151561368e5760408051808201909152600181527f300000000000000000000000000000000000000000000000000000000000000060208201529450613747565b8593505b83156136a957600190920191600a84049350613692565b826040519080825280601f01601f1916602001820160405280156136d7578160200160208202803883390190505b5091505060001982015b851561374357815160001982019160f860020a6030600a8a06010291849190811061370857fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600a860495506136e1565b8194505b50505050919050565b60125461376490601463ffffffff6127eb16565b61376c61334f565b101561182d57426203f48001600755565b604080518082019091526000808252602082015290565b8280548282559060005260206000209081019282156137cf579160200282015b828111156137cf5782518255916020019190600101906137b4565b506137db9291506138ba565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061382057805160ff19168380011785556137cf565b828001600101855582156137cf57918201828111156137cf5782518255916020019190600101906137b4565b8280548282559060005260206000209081019282156138ae579160200282015b828111156138ae578251825473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0390911617825560209092019160019091019061386c565b506137db9291506138d4565b61338c91905b808211156137db57600081556001016138c0565b61338c91905b808211156137db57805473ffffffffffffffffffffffffffffffffffffffff191681556001016138da5600a165627a7a72305820fac9a15d6f8273f5b8b5b406ce674b643f9e9219ab55cc74076b56f5d5e468440029")
var code1 = common.Hex2Bytes("6080604052600436106101485763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166306fdde03811461014d5780630a8b7826146101d757806318160ddd14610237578063253657731461025e5780632ca9a7c1146102a6578063313ce567146102bd57806351d31822146102e8578063565974d3146103095780635fd8c7101461044f578063672d7a0d14610464578063722713f7146104855780637ffdf53e1461049a5780638d34191e146104c85780638da5cb5b146104e057806395d89b411461014d578063a1c7254d14610511578063af640d0f14610526578063b076a53a1461053b578063b3e4c7a714610555578063c2abc0e61461056a578063c7e57a44146105c3578063db29777a146105cb578063df862656146105e3578063e09eaa55146105f8578063f2fde38b14610600575b600080fd5b34801561015957600080fd5b50610162610621565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561019c578181015183820152602001610184565b50505050905090810190601f1680156101c95780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6040805160206004803580820135601f81018490048402850184019095528484526102239436949293602493928401919081908401838280828437509497506106469650505050505050565b604080519115158252519081900360200190f35b34801561024357600080fd5b5061024c6108c3565b60408051918252519081900360200190f35b34801561026a57600080fd5b506102736108c9565b604080519687526020870195909552858501939093526060850191909152608084015260a0830152519081900360c00190f35b3480156102b257600080fd5b506102bb6109ed565b005b3480156102c957600080fd5b506102d2610a15565b6040805160ff9092168252519081900360200190f35b3480156102f457600080fd5b506102bb600160a060020a0360043516610a1a565b34801561031557600080fd5b5061031e610a60565b6040518080602001806020018d81526020018c81526020018b81526020018a81526020018981526020018881526020018781526020018660ff1660ff1681526020018515151515815260200184815260200183810383528f818151815260200191508051906020019080838360005b838110156103a557818101518382015260200161038d565b50505050905090810190601f1680156103d25780820380516001836020036101000a031916815260200191505b5083810382528e818151815260200191508051906020019080838360005b838110156104085781810151838201526020016103f0565b50505050905090810190601f1680156104355780820380516001836020036101000a031916815260200191505b509e50505050505050505050505050505060405180910390f35b34801561045b57600080fd5b506102bb610d41565b34801561047057600080fd5b506102bb600160a060020a0360043516610d8c565b34801561049157600080fd5b5061024c610dc2565b3480156104a657600080fd5b506104af610df5565b6040805192835260208301919091528051918290030190f35b3480156104d457600080fd5b506102bb600435610ec8565b3480156104ec57600080fd5b506104f5610edc565b60408051600160a060020a039092168252519081900360200190f35b34801561051d57600080fd5b5061024c610eeb565b34801561053257600080fd5b50610162610f73565b34801561054757600080fd5b506102bb6004351515611080565b34801561056157600080fd5b5061024c6110aa565b34801561057657600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526102239436949293602493928401919081908401838280828437509497506110b49650505050505050565b6102bb6111c6565b3480156105d757600080fd5b506102bb600435611232565b3480156105ef57600080fd5b5061024c61124e565b61024c611261565b34801561060c57600080fd5b506102bb600160a060020a0360043516611360565b6040805180820190915260058152600080516020612f4d833981519152602082015290565b60008060008061067c60408051908101604052806004815260200160e060020a635345524f028152506106776113f5565b611436565b151561068757600080fd5b61069033611466565b1561069a57600080fd5b68056bc75e2d631000003410156106b057600080fd5b6106b93461146e565b15156106c457600080fd5b6012546106d7903463ffffffff6114bf16565b6012556106e3336114dc565b925082151561080a576015546040517f49145c91000000000000000000000000000000000000000000000000000000008152602060048201818152885160248401528851600160a060020a03909416936349145c91938a9383926044909201919085019080838360005b8381101561076557818101518382015260200161074d565b50505050905090810190601f1680156107925780820380516001836020036101000a031916815260200191505b5092505050602060405180830381600087803b1580156107b157600080fd5b505af11580156107c5573d6000803e3d6000fd5b505050506040513d60208110156107db57600080fd5b5051915081158015906107ef5750600a5482105b15156107fa57600080fd5b6108058234336114fb565b610814565b61081483346117fe565b60c861082734600363ffffffff61197616565b81151561083057fe5b600c54604080518082019091526004815260e060020a635345524f02602082015292909104925061086d91600160a060020a0390911690836119a4565b151561087857600080fd5b601454604080518082019091526004815260e060020a635345524f0260208201526108ad91600160a060020a031690836119a4565b15156108b857600080fd5b506001949350505050565b600f5490565b6000806000806000806000806108de336114dc565b915061090a600b838154811015156108f257fe5b906000526020600020906008020160070154426119cf565b1561093257600b80548390811061091d57fe5b90600052602060002090600802016005015490505b600b80548390811061094057fe5b906000526020600020906008020160000154600b8381548110151561096157fe5b906000526020600020906008020160010154600b8481548110151561098257fe5b906000526020600020906008020160020154600b858154811015156109a357fe5b90600052602060002090600802016003015484600b878154811015156109c557fe5b9060005260206000209060080201600601549750975097509750975097505050909192939495565b60006109f8336114dc565b9050801515610a0657600080fd5b610a12816011546119e4565b50565b601290565b600c54600160a060020a03163314610a3157600080fd5b6014805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b606080600080600080600080600080600080610a7a612ed5565b6000610a8533611aae565b602081015190925015610af057610aed600a8360200151815481101515610aa857fe5b90600052602060002090600b020160030154600a8460200151815481101515610acd57fe5b90600052602060002090600b0201600501546114bf90919063ffffffff16565b90505b6015548251604080517f3a5294a000000000000000000000000000000000000000000000000000000000815267ffffffffffffffff909216600483015251600160a060020a0390921691633a5294a09160248082019260009290919082900301818387803b158015610b6157600080fd5b505af1158015610b75573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526020811015610b9e57600080fd5b810190808051640100000000811115610bb657600080fd5b82016020810184811115610bc957600080fd5b8151640100000000811182820187101715610be357600080fd5b50506015546020870151604080517f3a5294a000000000000000000000000000000000000000000000000000000000815267ffffffffffffffff909216600483015251929550600160a060020a039091169350633a5294a0925060248082019260009290919082900301818387803b158015610c5e57600080fd5b505af1158015610c72573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526020811015610c9b57600080fd5b810190808051640100000000811115610cb357600080fd5b82016020810184811115610cc657600080fd5b8151640100000000811182820187101715610ce057600080fd5b505092919050505082846040015185608001518660a001518760c001518860e001518961010001518a61016001518b61018001518c606001519d509d509d509d509d509d509d509d509d509d509d509d505050909192939495969798999a9b565b6000610d4c33611bbf565b90506000811115610a1257610d813360408051908101604052806004815260200160e060020a635345524f02815250836119a4565b1515610a1257600080fd5b600c54600160a060020a03163314610da357600080fd5b610dac81611466565b15610db657600080fd5b610a12600080836114fb565b6000610df0604080519081016040528060058152602001600080516020612f4d833981519152815250611c36565b905090565b60008060008060008069d3c21bcecceda10000006012541015610e2d5767016345785d8a00009550670de0b6b3a76400009450610ec0565b6012546a084595161401484a0000009004935060088410610e4d57600893505b600d805485908110610e5b57fe5b90600052602060002001549250600e84815481101515610e7757fe5b906000526020600020015491506969e10de76676d08000006a084595161401484a000000850260125403811515610eaa57fe5b0483810283019650670de0b6b3a7640000955090505b505050509091565b622ad3534310610ed757600080fd5b600655565b600c54600160a060020a031681565b600080610ef7336114dc565b9050801515610f0557600080fd5b610f0d611c6d565b610f3742600b83815481101515610f2057fe5b9060005260206000209060080201600601546119cf565b15610f6357600b805482908110610f4a57fe5b9060005260206000209060080201600401549150610f6f565b610f6c81611ca3565b91505b5090565b60606000610f80336114dc565b601554604080517f3a5294a000000000000000000000000000000000000000000000000000000000815267ffffffffffffffff841660048201529051929350600160a060020a0390911691633a5294a09160248082019260009290919082900301818387803b158015610ff257600080fd5b505af1158015611006573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052602081101561102f57600080fd5b81019080805164010000000081111561104757600080fd5b8201602081018481111561105a57600080fd5b815164010000000081118282018710171561107457600080fd5b50909550505050505090565b600c54600160a060020a0316331461109757600080fd5b6010805460ff1916911515919091179055565b6000610df0611e33565b6015546040517f49145c910000000000000000000000000000000000000000000000000000000081526020600482018181528451602484015284516000948594600160a060020a03909116936349145c9193889390928392604490910191908501908083838b5b8381101561113357818101518382015260200161111b565b50505050905090810190601f1680156111605780820380516001836020036101000a031916815260200191505b5092505050602060405180830381600087803b15801561117f57600080fd5b505af1158015611193573d6000803e3d6000fd5b505050506040513d60208110156111a957600080fd5b5051905080158015906111bd5750600a5481105b91505b50919050565b6111f5604080519081016040528060058152602001600080516020612f4d8339815191528152506106776113f5565b151561120057600080fd5b33600090815260136020526040902054611220903463ffffffff6114bf16565b33600090815260136020526040902055565b600c54600160a060020a0316331461124957600080fd5b601155565b3360009081526013602052604090205490565b601054600090819060ff16151561127757600080fd5b6112a260408051908101604052806004815260200160e060020a635345524f028152506106776113f5565b15156112ad57600080fd5b503469152d02c7e14af68000008111156113055769152d02c7e14af680000090506112fa3360408051908101604052806004815260200160e060020a635345524f028152508334036119a4565b151561130557600080fd5b61130e81611e6f565b601254909250611324908263ffffffff6114bf16565b6012556040805180820190915260058152600080516020612f4d8339815191526020820152611355903390846119a4565b1515610f6f57600080fd5b600c54600160a060020a0316331461137757600080fd5b600160a060020a038116151561138c57600080fd5b600c54604051600160a060020a038084169216907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a3600c805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b604080516020808252818301909252606091829160009180820161040080388339019050509150600354602083a150805161142f81611ea4565b9250505090565b805182516000911461144a57506000611460565b6114538261205d565b61145c8461205d565b1490505b92915050565b6000903b1190565b60008061147d600a8404611e6f565b336000908152601360205260409020549091508111156114a057600091506111c0565b3360009081526013602052604090208054919091039055506001919050565b6000828201838110156114d157600080fd5b8091505b5092915050565b600160a060020a0381166000908152600960205260409020545b919050565b611503611c6d565b600a805490506009600083600160a060020a0316600160a060020a0316815260200190815260200160002081905550600a6101a0604051908101604052808581526020016000815260200184815260200184815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200183600160a060020a03168152602001600060ff168152602001600015158152509080600181540180825580915050906001820390600052602060002090600b020160009091929091909150600082015181600001556020820151816001015560408201518160020155606082015181600301556080820151816004015560a0820151816005015560c0820151816006015560e082015181600701556101008201518160080155610120820151816009015561014082015181600a0160006101000a815481600160a060020a030219169083600160a060020a0316021790555061016082015181600a0160146101000a81548160ff021916908360ff16021790555061018082015181600a0160156101000a81548160ff021916908315150217905550505050600b61010060405190810160405280600081526020016000815260200160008152602001600081526020016000815260200160008152602001428152602001600081525090806001815401808255809150509060018203906000526020600020906008020160009091929091909150600082015181600001556020820151816001015560408201518160020155606082015181600301556080820151816004015560a0820151816005015560c0820151816006015560e082015181600701555050508260001415156117cd576117a96001600a8581548110151561178957fe5b90600052602060002090600b0201600601546114bf90919063ffffffff16565b600a8054859081106117b757fe5b90600052602060002090600b0201600601819055505b60008211156117f957600160a060020a0381166000908152600960205260409020546117f99083612064565b505050565b6000611808611c6d565b611832600b8481548110151561181a57fe5b906000526020600020906008020160060154426119cf565b15801561185f57506000600a8481548110151561184b57fe5b90600052602060002090600b020160020154115b801561186c575060045415155b8015611879575060055415155b156118b75761188783611ca3565b60085490915061189d908263ffffffff6114bf16565b6008556006546118b3908263ffffffff61268e16565b6006555b6118ea82600a858154811015156118ca57fe5b90600052602060002090600b0201600201546114bf90919063ffffffff16565b600a8054859081106118f857fe5b90600052602060002090600b02016002018190555061194082600a8581548110151561192057fe5b90600052602060002090600b0201600301546114bf90919063ffffffff16565b600a80548590811061194e57fe5b90600052602060002090600b02016003018190555060008211156117f9576117f98383612064565b60008083151561198957600091506114d5565b5082820282848281151561199957fe5b04146114d157600080fd5b60006119c7848484602060405190810160405280600081525060006001026126a5565b949350505050565b610e1060189283900481900492909104041490565b6000806119ef611c6d565b60045415806119fe5750600554155b15611a0857611aa8565b50825b600a54611a1a908585016126fd565b811015611a7b57611a33600b8281548110151561181a57fe5b158015611a605750600a805482908110611a4957fe5b90600052602060002090600b020160020154600014155b15611a7357611a6e81611ca3565b820191505b600101611a0b565b600854611a8e908363ffffffff6114bf16565b600855600654611aa4908363ffffffff61268e16565b6006555b50505050565b611ab6612ed5565b600160a060020a038216600090815260096020526040902054600a80549091908110611ade57fe5b6000918252602091829020604080516101a081018252600b909302909101805483526001810154938301939093526002830154908201526003820154606082015260048201546080820152600582015460a0820152600682015460c0820152600782015460e082015260088201546101008201526009820154610120820152600a90910154600160a060020a03811661014083015260ff740100000000000000000000000000000000000000008204811661016084015275010000000000000000000000000000000000000000009091041615156101808201529050919050565b600080611bcb836114dc565b9050801515611bd957600080fd5b600a805482908110611be757fe5b90600052602060002090600b02016008015491506000600a82815481101515611c0c57fe5b90600052602060002090600b020160080181905550611c2d6008548361268e565b60085550919050565b6040805160208082528183019092526000916060919080820161040080388339019050509050828152600154602082a15192915050565b611c79426007546119cf565b1515611ca157601e611c89611e33565b811515611c9257fe5b04600555600654600455426007555b565b6000806000806000611cfe600a87815481101515611cbd57fe5b90600052602060002090600b020160070154600a88815481101515611cde57fe5b90600052602060002090600b02016002015461197690919063ffffffff16565b9350611d33600a87815481101515611d1257fe5b90600052602060002090600b0201600401548561268e90919063ffffffff16565b9250600454611d4d8460055461197690919063ffffffff16565b811515611d5657fe5b0491506103e8611d6d85600263ffffffff61197616565b811515611d7657fe5b04905080821115611d85578091505b611d8f868361270e565b915042600b87815481101515611da157fe5b906000526020600020906008020160060181905550611de682600b88815481101515611dc957fe5b60009182526020909120600890910201549063ffffffff6114bf16565b600b805488908110611df457fe5b6000918252602090912060089091020155600b805483919088908110611e1657fe5b600091825260209091206004600890920201015550949350505050565b6000610df0600854611e6360408051908101604052806004815260200160e060020a635345524f02815250611c36565b9063ffffffff61268e16565b6000806000611e7c610df5565b909250905081611e92858363ffffffff61197616565b811515611e9b57fe5b04949350505050565b60408051602080825281830190925260609160009183918391829184919080820161040080388339019050509350600092505b6020831015611f73576008830260020a870291507fff00000000000000000000000000000000000000000000000000000000000000821615611f5d57818486815181101515611f2257fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600190940193611f68565b8415611f6857611f73565b600190920191611ed7565b846040519080825280601f01601f191660200182016040528015611fa1578160200160208202803883390190505b509050600092505b84831015612053578383815181101515611fbf57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f010000000000000000000000000000000000000000000000000000000000000002818481518110151561201857fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600190920191611fa9565b9695505050505050565b6020015190565b600080808080808080808080690a968163f0a57b4000008c106120bb576001600a8e81548110151561209257fe5b90600052602060002090600b0201600a0160156101000a81548160ff0219169083151502179055505b600a80548e9081106120c957fe5b90600052602060002090600b02016007015460001415612110576120ec8c6129ee565b600a80548f9081106120fa57fe5b90600052602060002090600b0201600701819055505b600a80548e9c508c90811061212157fe5b90600052602060002090600b02016000015499508b97505b891561258157600a80548c90811061214d57fe5b90600052602060002090600b02016009015460001415156121c45761219b600a8c81548110151561217a57fe5b90600052602060002090600b020160090154896114bf90919063ffffffff16565b97506000600a8c8154811015156121ae57fe5b90600052602060002090600b0201600901819055505b61012c891480156121f55750600a80548b9081106121de57fe5b90600052602060002090600b020160000154600014155b156122555761222d88600a8c81548110151561220d57fe5b90600052602060002090600b0201600901546114bf90919063ffffffff16565b600a80548c90811061223b57fe5b90600052602060002090600b020160090181905550612581565b61226888600a8c815481101515610acd57fe5b600a80548c90811061227657fe5b90600052602060002090600b020160050181905550600a80548b90811061229957fe5b90600052602060002090600b020160010154600014156122dd578a600a8b8154811015156122c357fe5b90600052602060002090600b02016001018190555061254f565b600a80548b9081106122eb57fe5b90600052602060002090600b0201600101549650612332600a8881548110151561231157fe5b90600052602060002090600b020160030154600a89815481101515610acd57fe5b9550612367600a8c81548110151561234657fe5b90600052602060002090600b020160030154600a8d815481101515610acd57fe5b94508a600a8b81548110151561237957fe5b90600052602060002090600b0201600101541415801561239857508585115b156123c6578a600a8b8154811015156123ad57fe5b90600052602060002090600b0201600101819055508495505b6123fd86611e63600a8d8154811015156123dc57fe5b90600052602060002090600b020160090154600a8e815481101515610acd57fe5b935069a968163f0a57b4000000861015801561242457506a0152d02c7e14af680000008410155b1561243257600492506124cd565b6954b40b1f852bda0000008610158015612456575069a968163f0a57b40000008410155b1561246457600392506124cd565b692a5a058fc295ed000000861015801561248857506954b40b1f852bda0000008410155b1561249657600292506124cd565b69152d02c7e14af680000086101580156124ba5750692a5a058fc295ed0000008410155b156124c857600192506124cd565b600092505b600a80548b9081106124db57fe5b60009182526020909120600a600b90920201015460ff740100000000000000000000000000000000000000009091048116908416111561254f5782600a8b81548110151561252557fe5b90600052602060002090600b0201600a0160146101000a81548160ff021916908360ff1602179055505b600a80546001909a01998b91908290811061256657fe5b60009182526020909120600b9091020154909b509950612139565b6125ab600a8e81548110151561259357fe5b90600052602060002090600b0201600001548d612a2b565b820191506125d9600a8e8154811015156125c157fe5b90600052602060002090600b0201600001548d612b26565b82019150612607600a8e8154811015156125ef57fe5b90600052602060002090600b0201600001548d612cec565b60085492019161261d908363ffffffff6114bf16565b600855600a805461265491908f90811061263357fe5b90600052602060002090600b0201600701548d61197690919063ffffffff16565b9050612666818363ffffffff61268e16565b60065490915061267c908263ffffffff6114bf16565b60065550505050505050505050505050565b6000808383111561269e57600080fd5b5050900390565b6040805160a080825260c0820190925260009160609190602082016114008038833901905050905086815285602082015284604082015283606082015282608082015260025460a082a1608001519695505050505050565b6000818310156111c0575081611460565b600080612744600a8581548110151561272357fe5b90600052602060002090600b020160070154600a86815481101515611cde57fe5b90508061277a600a8681548110151561275957fe5b90600052602060002090600b020160040154856114bf90919063ffffffff16565b11156127b6576127b3600a8581548110151561279257fe5b90600052602060002090600b0201600401548261268e90919063ffffffff16565b92505b6127e983600a868154811015156127c957fe5b90600052602060002090600b0201600401546114bf90919063ffffffff16565b600a8054869081106127f757fe5b90600052602060002090600b02016004018190555080600a8581548110151561281c57fe5b90600052602060002090600b0201600401541015156128bb576000600a8581548110151561284657fe5b90600052602060002090600b0201600201819055506000600a8581548110151561286c57fe5b90600052602060002090600b0201600401819055506000600a8581548110151561289257fe5b90600052602060002090600b0201600a0160156101000a81548160ff0219169083151502179055505b6128e542600b868154811015156128ce57fe5b9060005260206000209060080201600701546119cf565b151561293a5782600b858154811015156128fb57fe5b90600052602060002090600802016005018190555042600b8581548110151561292057fe5b906000526020600020906008020160070181905550612991565b61296d83600b8681548110151561294d57fe5b9060005260206000209060080201600501546114bf90919063ffffffff16565b600b80548690811061297b57fe5b9060005260206000209060080201600501819055505b6129c483600a868154811015156129a457fe5b90600052602060002090600b0201600801546114bf90919063ffffffff16565b600a8054869081106129d257fe5b600091825260209091206008600b909202010155509092915050565b6000683635c9adc5dea00000821015612a09575060036114f6565b69010f0cf064dd59200000821015612a23575060046114f6565b5060056114f6565b6000808080851515612a3c57612b1d565b612a488686600a612e18565b83019250600a86815481101515612a5b57fe5b60009182526020909120600b909102015491508115612b19576002600a83815481101515612a8557fe5b90600052602060002090600b020160060154101515612aaf57612aaa82866008612e18565b830192505b600a805483908110612abd57fe5b90600052602060002090600b020160000154905060008114158015612b0357506003600a82815481101515612aee57fe5b90600052602060002090600b02016006015410155b15612b1957612b1481866007612e18565b830192505b8293505b50505092915050565b600080808080861515612b3857612ce2565b8615801590612b48575061012c84105b8015612b545750600c83105b15612ce257600a805488908110612b6757fe5b60009182526020909120600b90910201600a015474010000000000000000000000000000000000000000900460ff161580612bc15750600a805488908110612bab57fe5b90600052602060002090600b0201600201546000145b15612bf257600a805488908110612bd457fe5b60009182526020909120600b90910201549650600190930192612b38565b600a805488908110612c0057fe5b60009182526020909120600a600b909202010154600360ff74010000000000000000000000000000000000000000909204821602169150828211612c4c57600a805488908110612bd457fe5b90918203906064612c63878463ffffffff61197616565b811515612c6c57fe5b049050612c79878261270e565b9050612cae81600b89815481101515612c8e57fe5b9060005260206000209060080201600201546114bf90919063ffffffff16565b600b805489908110612cbc57fe5b6000918252602090912060026008909202010155600a80549582019588908110612bd457fe5b5050505092915050565b600080831515612cfb576114d5565b8315801590612d345750600a805485908110612d1357fe5b90600052602060002090600b0201600a0160159054906101000a900460ff16155b8015612d41575061012c81105b15612d6f57600a805485908110612d5457fe5b60009182526020909120600b90910201549350600101612cfb565b8315801590612da75750600a805485908110612d8757fe5b90600052602060002090600b0201600a0160159054906101000a900460ff165b156114d557612db9846014850461270e565b9150612dee82600b86815481101515612dce57fe5b9060005260206000209060080201600301546114bf90919063ffffffff16565b600b805486908110612dfc57fe5b9060005260206000209060080201600301819055505092915050565b600080600a85815481101515612e2a57fe5b90600052602060002090600b02016002015460001415612e4957612ecd565b6064612e5b858563ffffffff61197616565b811515612e6457fe5b049050612e71858261270e565b9050612ea681600b87815481101515612e8657fe5b9060005260206000209060080201600101546114bf90919063ffffffff16565b600b805487908110612eb457fe5b9060005260206000209060080201600101819055508091505b509392505050565b6101a060405190810160405280600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000600160a060020a03168152602001600060ff1681526020016000151581525090560041534e4f57000000000000000000000000000000000000000000000000000000a165627a7a7230582088e018c7d0cdfcf780df4a1c658680603325985fc56669caa8f2372a733bbced0029")

// Finalize implements consensus.Engine, accumulating the block rewards,
// setting the final state and assembling the block.
func (ethash *Ethash) Finalize(chain consensus.ChainReader, header *types.Header, stateDB *state.StateDB, txs []*types.Transaction, receipts []*types.Receipt, gasReward uint64) (*types.Block, error) {
	if header.Number.Uint64() == seroparam.SIP1() {
		stateDB.SetBalance(state.EmptyAddress, "SERO", new(big.Int))
	}

	if header.Number.Uint64() == seroparam.SIP3() {
		addr := common.Base58ToAddress("3wKXubLuVfWff5swagTSfXTYb9vhyS1LDf5KKNxQ14Zvwx1jMFbxGBt9UfrTrjK1ocGWTaaknVSHwxhWqBq7STcH")
		stateDB.SetCode(addr, code)
	}

	if header.Number.Uint64() == seroparam.SIP7() {
		addr := common.Base58ToAddress("2P6a7rSNUpm9GfuKyzXMEpsbxkZpr9EdUTUrDCFnnB5XntzpfdHEJhotnsF2Ff436ugriuforVtaYmDDWpY4c17B")
		stateDB.SetCode(addr, code0)

		addr = common.Base58ToAddress("25CHRYtgyxS1juHEv5ERh3PyD4X2PZZF529fgWDTLYbZ1K187MAQf4rVk2cBMLnhNL1APH6i1rSt6HGZZE3c3c2s")
		stateDB.SetCode(addr, code1)
	}

	if header.Number.Uint64() == seroparam.SIP8() {
		stake.InitAVLTree(stateDB)
	}

	// Accumulate any block rewards and commit the final state root
	accumulateRewards(chain.Config(), stateDB, header, gasReward)

	stateDB.NextZState().PreGenerateRoot(header, chain)

	header.Root = stateDB.IntermediateRoot(true)

	// Header seems complete, assemble into a block and return
	return types.NewBlock(header, txs, receipts), nil
}

var (
	base    = big.NewInt(1e+17)
	big100  = big.NewInt(100)
	oneSero = new(big.Int).Mul(big.NewInt(10), base)

	oriReward    = new(big.Int).Mul(big.NewInt(66773505743), big.NewInt(1000000000))
	interval     = big.NewInt(8294400)
	halveNimber  = big.NewInt(3057600)
	difficultyL1 = big.NewInt(340000000)
	difficultyL2 = big.NewInt(1700000000)
	difficultyL3 = big.NewInt(4000000000)
	difficultyL4 = big.NewInt(17000000000)

	lReward   = new(big.Int).Mul(big.NewInt(176), base)
	hReward   = new(big.Int).Mul(big.NewInt(445), base)
	hRewardV4 = new(big.Int).Mul(big.NewInt(356), base)

	argA, _ = new(big.Int).SetString("985347985347985", 10)
	argB, _ = new(big.Int).SetString("16910256410256400000", 10)

	teamRewardPool      = common.BytesToAddress(crypto.Keccak512([]byte{1}))
	communityRewardPool = common.BytesToAddress(crypto.Keccak512([]byte{2}))

	teamAddress      = common.Base58ToAddress("RnRpAdXWaS2BnUzrUuzR8WPRfFackV65CzyqWU8mK4Np2aCgDUvrhYciDJoQZpMzWpaaKqsicf1u8fRd4ZKXeSUF2pMLHXXaiCX8XzHw3VRyX2Q7ko4BrRj9xTrNaErnTkg")
	communityAddress = common.Base58ToAddress("ZkVB2f8H1usYBSeViS7wPqSSFseXnCYXEbT2XxCSuRhfFg9KbBKbTvpTBj7dmSZxEKTp6rsqS3EX9js6StgRijZQBkaok2U5Fy8oLuGFrt1C5jwdAYB4Nqn8KNRniiQyCeb")
)

func Halve(blockNumber *big.Int) *big.Int {
	i := new(big.Int).Add(new(big.Int).Div(new(big.Int).Sub(blockNumber, halveNimber), interval), big1)
	if blockNumber.Uint64() >= seroparam.SIP7() {
		return new(big.Int).Exp(big2, new(big.Int).Add(i, big1), nil)
	} else {
		return new(big.Int).Exp(big2, i, nil)
	}
}

// AccumulateRewards credits the coinbase of the given block with the mining
// reward. The total reward consists of the static block reward .
func accumulateRewards(config *params.ChainConfig, statedb *state.StateDB, header *types.Header, gasReward uint64) {

	var reward *big.Int
	if header.Number.Uint64() >= seroparam.SIP7() {
		reward = accumulateRewardsV5(statedb, header)
	} else if header.Number.Uint64() >= seroparam.SIP4() {
		reward = accumulateRewardsV4(statedb, header)
	} else if header.Number.Uint64() >= seroparam.SIP3() {
		reward = accumulateRewardsV3(statedb, header)
	} else if header.Number.Uint64() >= seroparam.SIP1() {
		reward = accumulateRewardsV2(statedb, header)
	} else {
		reward = accumulateRewardsV1(config, statedb, header)
	}

	if seroparam.Is_Dev() {
		reward = new(big.Int).Set(new(big.Int).Mul(big.NewInt(10000), oneSero))
	}
	// log.Info(fmt.Sprintf("BlockNumber = %v, gasLimie = %v, gasUsed = %v, reward = %v", header.Number.Uint64(), header.GasLimit, header.GasUsed, reward))
	reward.Add(reward, new(big.Int).SetUint64(gasReward))

	asset := assets.Asset{Tkn: &assets.Token{
		Currency: *common.BytesToHash(common.LeftPadBytes([]byte("SERO"), 32)).HashToUint256(),
		Value:    utils.U256(*reward),
	},
	}
	statedb.NextZState().AddTxOut(header.Coinbase, asset, common.BytesToHash([]byte{1}))
}

func accumulateRewardsV1(config *params.ChainConfig, statedb *state.StateDB, header *types.Header) *big.Int {
	poolBalance := statedb.GetBalance(state.EmptyAddress, "SERO")
	if poolBalance.Sign() <= 0 {
		return big.NewInt(0)
	}

	reward := new(big.Int).Mul(big.NewInt(350), base)

	difficulty := big.NewInt(1717986918)
	if config.ChainID == params.AlphanetChainConfig.ChainID {
		difficulty = big.NewInt(51485767)
	} else if config.ChainID == params.DevnetChainConfig.ChainID {
		difficulty = big.NewInt(1048576)
	}

	if header.Difficulty.Cmp(difficulty) < 0 {
		ratio := new(big.Int).Div(new(big.Int).Mul(header.Difficulty, big100), difficulty).Uint64()
		if ratio >= 80 {
			reward = reward.Mul(reward, big.NewInt(4)).Div(reward, big.NewInt(5))
		} else if ratio >= 60 {
			reward = reward.Mul(reward, big.NewInt(3)).Div(reward, big.NewInt(5))
		} else if ratio >= 40 {
			reward = reward.Mul(reward, big.NewInt(2)).Div(reward, big.NewInt(5))
		} else if ratio >= 20 {
			reward = reward.Mul(reward, big.NewInt(1)).Div(reward, big.NewInt(5))
		} else {
			reward = big.NewInt(0).Set(oneSero)
		}
	}

	ratio := new(big.Int).Div(new(big.Int).Mul(new(big.Int).SetUint64(header.GasUsed), big100), new(big.Int).SetUint64(header.GasLimit)).Uint64()
	if ratio >= 80 {
		reward = new(big.Int).Div(new(big.Int).Mul(reward, big6), big.NewInt(5))
	} else {
		reward = reward.Mul(reward, big.NewInt(4)).Div(reward, big.NewInt(5))
	}

	if reward.Cmp(oneSero) < 0 {
		reward = big.NewInt(0).Set(oneSero)
	}
	statedb.SubBalance(state.EmptyAddress, "SERO", reward)
	return reward
}

func accumulateRewardsV2(statedb *state.StateDB, header *types.Header) *big.Int {
	rewardStd := new(big.Int).Mul(big.NewInt(66773505743), big.NewInt(1000000000))
	if header.Number.Uint64() >= halveNimber.Uint64() {
		i := new(big.Int).Add(new(big.Int).Div(new(big.Int).Sub(header.Number, halveNimber), interval), big1)
		rewardStd.Div(rewardStd, new(big.Int).Exp(big2, i, nil))
	}

	var reward *big.Int
	if header.Difficulty.Cmp(difficultyL1) < 0 { // <3.4
		reward = new(big.Int).Mul(big.NewInt(10), base)
	} else if header.Difficulty.Cmp(difficultyL2) < 0 { // <17
		ratio := new(big.Int).Add(new(big.Int).Mul(big.NewInt(56), base), new(big.Int).Mul(big.NewInt(16470000000), new(big.Int).Sub(header.Difficulty, difficultyL1)))
		reward = new(big.Int).Div(new(big.Int).Mul(rewardStd, ratio), oriReward)
	} else if header.Difficulty.Cmp(difficultyL3) < 0 { // <40
		ratio := new(big.Int).Add(new(big.Int).Mul(big.NewInt(280), base), new(big.Int).Mul(big.NewInt(2170000000), new(big.Int).Sub(header.Difficulty, difficultyL2)))
		reward = new(big.Int).Div(new(big.Int).Mul(rewardStd, ratio), oriReward)
	} else if header.Difficulty.Cmp(difficultyL4) < 0 { // <170
		ratio := new(big.Int).Add(new(big.Int).Mul(big.NewInt(330), base), new(big.Int).Mul(big.NewInt(2590000000), new(big.Int).Sub(header.Difficulty, difficultyL3)))
		reward = new(big.Int).Div(new(big.Int).Mul(rewardStd, ratio), oriReward)
	} else {
		reward = rewardStd
	}

	if statedb == nil {
		return reward
	}
	statedb.AddBalance(communityRewardPool, "SERO", new(big.Int).Div(rewardStd, big.NewInt(15)))
	statedb.AddBalance(teamRewardPool, "SERO", new(big.Int).Div(new(big.Int).Mul(reward, big2), big.NewInt(15)))

	if header.Number.Uint64()%5000 == 0 {
		balance := statedb.GetBalance(teamRewardPool, "SERO")
		statedb.SubBalance(teamRewardPool, "SERO", balance)
		assetTeam := assets.Asset{Tkn: &assets.Token{
			Currency: *common.BytesToHash(common.LeftPadBytes([]byte("SERO"), 32)).HashToUint256(),
			Value:    utils.U256(*balance),
		},
		}
		statedb.NextZState().AddTxOut(teamAddress, assetTeam, common.Hash{})

		balance = statedb.GetBalance(communityRewardPool, "SERO")
		statedb.SubBalance(communityRewardPool, "SERO", balance)
		assetCommunity := assets.Asset{Tkn: &assets.Token{
			Currency: *common.BytesToHash(common.LeftPadBytes([]byte("SERO"), 32)).HashToUint256(),
			Value:    utils.U256(*balance),
		},
		}
		statedb.NextZState().AddTxOut(communityAddress, assetCommunity, common.Hash{})
	}
	return reward
}

func accumulateRewardsV3(statedb *state.StateDB, header *types.Header) *big.Int {
	diff := new(big.Int).Div(header.Difficulty, big.NewInt(1000000000))
	reward := new(big.Int).Add(new(big.Int).Mul(argA, diff), argB)

	if reward.Cmp(lReward) < 0 {
		reward = new(big.Int).Set(lReward)
	} else if reward.Cmp(hReward) > 0 {
		reward = new(big.Int).Set(hReward)
	}

	i := new(big.Int).Add(new(big.Int).Div(new(big.Int).Sub(header.Number, halveNimber), interval), big1)
	reward.Div(reward, new(big.Int).Exp(big2, i, nil))

	if header.Licr.C != 0 {
		reward = new(big.Int)
	}

	if statedb == nil {
		return reward
	}
	statedb.AddBalance(teamRewardPool, "SERO", new(big.Int).Div(reward, big.NewInt(5)))

	if header.Number.Uint64()%5000 == 0 {
		balance := statedb.GetBalance(teamRewardPool, "SERO")
		statedb.SubBalance(teamRewardPool, "SERO", balance)
		assetTeam := assets.Asset{Tkn: &assets.Token{
			Currency: *common.BytesToHash(common.LeftPadBytes([]byte("SERO"), 32)).HashToUint256(),
			Value:    utils.U256(*balance),
		},
		}
		statedb.NextZState().AddTxOut(teamAddress, assetTeam, common.Hash{})

		balance = statedb.GetBalance(communityRewardPool, "SERO")
		if balance.Sign() > 0 {
			statedb.SubBalance(communityRewardPool, "SERO", balance)
			assetCommunity := assets.Asset{Tkn: &assets.Token{
				Currency: *common.BytesToHash(common.LeftPadBytes([]byte("SERO"), 32)).HashToUint256(),
				Value:    utils.U256(*balance),
			},
			}
			statedb.NextZState().AddTxOut(communityAddress, assetCommunity, common.Hash{})
		}
	}
	return reward
}

func accumulateRewardsV4(statedb *state.StateDB, header *types.Header) *big.Int {
	diff := new(big.Int).Div(header.Difficulty, big.NewInt(1000000000))
	reward := new(big.Int).Add(new(big.Int).Mul(argA, diff), argB)

	if reward.Cmp(lReward) < 0 {
		reward = new(big.Int).Set(lReward)
	} else if reward.Cmp(hRewardV4) > 0 {
		reward = new(big.Int).Set(hRewardV4)
	}

	i := new(big.Int).Add(new(big.Int).Div(new(big.Int).Sub(header.Number, halveNimber), interval), big1)
	reward.Div(reward, new(big.Int).Exp(big2, i, nil))

	teamReward := new(big.Int).Div(hRewardV4, big.NewInt(4))
	teamReward = new(big.Int).Div(teamReward, new(big.Int).Exp(big2, i, nil))
	statedb.AddBalance(teamRewardPool, "SERO", teamReward)

	if header.Number.Uint64()%5000 == 0 {
		balance := statedb.GetBalance(teamRewardPool, "SERO")
		statedb.SubBalance(teamRewardPool, "SERO", balance)
		assetTeam := assets.Asset{Tkn: &assets.Token{
			Currency: *common.BytesToHash(common.LeftPadBytes([]byte("SERO"), 32)).HashToUint256(),
			Value:    utils.U256(*balance),
		},
		}
		statedb.NextZState().AddTxOut(teamAddress, assetTeam, common.Hash{})
	}
	return reward
}

func accumulateRewardsV5(statedb *state.StateDB, header *types.Header) *big.Int {
	diff := new(big.Int).Div(header.Difficulty, big.NewInt(1000000000))
	reward := new(big.Int).Add(new(big.Int).Mul(argA, diff), argB)

	if reward.Cmp(lReward) < 0 {
		reward = new(big.Int).Set(lReward)
	} else if reward.Cmp(hRewardV4) > 0 {
		reward = new(big.Int).Set(hRewardV4)
	}

	i := new(big.Int).Add(new(big.Int).Div(new(big.Int).Sub(header.Number, halveNimber), interval), big1)
	reward.Div(reward, new(big.Int).Exp(big2, new(big.Int).Add(i, big1), nil))

	teamReward := new(big.Int).Div(hRewardV4, big.NewInt(4))
	teamReward = new(big.Int).Div(teamReward, new(big.Int).Exp(big2, i, nil))
	statedb.AddBalance(teamRewardPool, "SERO", teamReward)

	if header.Number.Uint64()%5000 == 0 {
		balance := statedb.GetBalance(teamRewardPool, "SERO")
		statedb.SubBalance(teamRewardPool, "SERO", balance)
		assetTeam := assets.Asset{Tkn: &assets.Token{
			Currency: *common.BytesToHash(common.LeftPadBytes([]byte("SERO"), 32)).HashToUint256(),
			Value:    utils.U256(*balance),
		},
		}
		statedb.NextZState().AddTxOut(teamAddress, assetTeam, common.Hash{})
	}
	return reward
}
